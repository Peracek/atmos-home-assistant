<!DOCTYPE html>
<html>
<head>
  <title>Atmos Temperatures</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    #chart { width: 100%; height: 700px; margin-top: 20px; }
    #status { color: #666; }
  </style>
</head>
<body>
  <h1>Atmos Temperatures</h1>
  <div id="status">Loading...</div>
  <div id="chart"></div>

  <script>
    const chartDom = document.getElementById('chart');
    const chart = echarts.init(chartDom);

    function buildKomfortRanges(data) {
      // data is array of { ts, mode }
      const ranges = [];
      let rangeStart = null;

      for (let i = 0; i < data.length; i++) {
        const isKomfort = data[i].mode === 'Auto (Komfort)';

        if (isKomfort && rangeStart === null) {
          rangeStart = data[i].ts;
        } else if (!isKomfort && rangeStart !== null) {
          ranges.push({ start: rangeStart, end: data[i - 1].ts });
          rangeStart = null;
        }
      }

      // Close any open range
      if (rangeStart !== null && data.length > 0) {
        ranges.push({ start: rangeStart, end: data[data.length - 1].ts });
      }

      return ranges;
    }

    async function loadData() {
      try {
        const res = await fetch('/atmos_history.csv');
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();

        const lines = text.trim().split('\n');
        const headers = lines[0].split(',');

        const pfIdx = headers.indexOf('pf');
        const pf2Idx = headers.indexOf('pf2');
        const pf3Idx = headers.indexOf('pf3');
        const roomIdx = headers.indexOf('roomTemp');
        const agfIdx = headers.indexOf('agf');
        const sfIdx = headers.indexOf('sf');
        const heatingModeIdx = headers.indexOf('heating_mode');

        // Use [timestamp, value] pairs for time-based x-axis
        const roomTemp = [], pf = [], pf2 = [], pf3 = [], agf = [], sf = [];
        const heatingModeData = [];
        let count = 0;

        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',');
          if (cols.length < 2) continue;

          const ts = new Date(cols[0]).getTime();
          if (isNaN(ts)) continue;

          count++;
          roomTemp.push([ts, parseFloat(cols[roomIdx]) || null]);
          pf.push([ts, parseFloat(cols[pfIdx]) || null]);
          pf2.push([ts, parseFloat(cols[pf2Idx]) || null]);
          pf3.push([ts, parseFloat(cols[pf3Idx]) || null]);
          agf.push([ts, agfIdx >= 0 ? (parseFloat(cols[agfIdx]) || null) : null]);
          sf.push([ts, sfIdx >= 0 ? (parseFloat(cols[sfIdx]) || null) : null]);

          if (heatingModeIdx >= 0) {
            heatingModeData.push({ ts, mode: cols[heatingModeIdx] || '' });
          }
        }

        document.getElementById('status').textContent = `${count} readings`;

        // Build markArea data for Komfort mode ranges
        const komfortRanges = buildKomfortRanges(heatingModeData);
        const markAreaData = komfortRanges.map(r => [
          { xAxis: r.start },
          { xAxis: r.end }
        ]);

        const markAreaConfig = {
          silent: true,
          itemStyle: {
            color: 'rgba(255, 193, 7, 0.15)'
          },
          data: markAreaData
        };

        const option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
          },
          legend: {
            data: ['Room Temp', 'PF (top)', 'PF2 (mid)', 'PF3 (bot)', 'SF', 'AGF'],
            top: 0
          },
          axisPointer: {
            link: [{ xAxisIndex: 'all' }]
          },
          grid: [
            {
              left: 60,
              right: 40,
              top: 50,
              height: '45%'
            },
            {
              left: 60,
              right: 40,
              top: '62%',
              height: '20%'
            }
          ],
          xAxis: [
            {
              type: 'time',
              gridIndex: 0,
              axisLabel: { show: false },
              axisTick: { show: false }
            },
            {
              type: 'time',
              gridIndex: 1
            }
          ],
          yAxis: [
            {
              type: 'value',
              name: '°C',
              nameLocation: 'middle',
              nameGap: 40,
              gridIndex: 0
            },
            {
              type: 'value',
              name: 'AGF °C',
              nameLocation: 'middle',
              nameGap: 40,
              gridIndex: 1
            }
          ],
          dataZoom: [
            {
              type: 'slider',
              xAxisIndex: [0, 1],
              start: 0,
              end: 100,
              bottom: 20
            },
            {
              type: 'inside',
              xAxisIndex: [0, 1],
              start: 0,
              end: 100
            }
          ],
          series: [
            {
              name: 'Room Temp',
              type: 'line',
              xAxisIndex: 0,
              yAxisIndex: 0,
              data: roomTemp,
              showSymbol: false,
              lineStyle: { color: '#e74c3c' },
              itemStyle: { color: '#e74c3c' },
              markArea: markAreaConfig
            },
            {
              name: 'PF (top)',
              type: 'line',
              xAxisIndex: 0,
              yAxisIndex: 0,
              data: pf,
              showSymbol: false,
              lineStyle: { color: '#3498db' },
              itemStyle: { color: '#3498db' }
            },
            {
              name: 'PF2 (mid)',
              type: 'line',
              xAxisIndex: 0,
              yAxisIndex: 0,
              data: pf2,
              showSymbol: false,
              lineStyle: { color: '#2ecc71' },
              itemStyle: { color: '#2ecc71' }
            },
            {
              name: 'PF3 (bot)',
              type: 'line',
              xAxisIndex: 0,
              yAxisIndex: 0,
              data: pf3,
              showSymbol: false,
              lineStyle: { color: '#e67e22' },
              itemStyle: { color: '#e67e22' }
            },
            {
              name: 'SF',
              type: 'line',
              xAxisIndex: 0,
              yAxisIndex: 0,
              data: sf,
              showSymbol: false,
              lineStyle: { color: '#1abc9c' },
              itemStyle: { color: '#1abc9c' }
            },
            {
              name: 'AGF',
              type: 'line',
              xAxisIndex: 1,
              yAxisIndex: 1,
              data: agf,
              showSymbol: false,
              lineStyle: { color: '#9b59b6' },
              itemStyle: { color: '#9b59b6' },
              markArea: markAreaConfig
            }
          ]
        };

        chart.setOption(option);
      } catch (err) {
        document.getElementById('status').textContent = 'Error: ' + err.message;
      }
    }

    window.addEventListener('resize', function() {
      chart.resize();
    });

    loadData();
  </script>
</body>
</html>
